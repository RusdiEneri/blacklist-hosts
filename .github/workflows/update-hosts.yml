name: Update Hosts Registry

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: update-hosts
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch Sources
        shell: bash
        run: |
          set -Eeuo pipefail

          declare -A SOURCES=(

            ["ads-track/adguard.txt"]="https://adguardteam.github.io/HostlistsRegistry/assets/filter_1.txt"
            ["ads-track/d3host.txt"]="https://raw.githubusercontent.com/Turtlecute33/toolz/master/src/d3host.adblock"

            ["fakenews/stevenblack.txt"]="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews/hosts"
            ["gambling/stevenblack.txt"]="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/gambling/hosts"
            ["porn/stevenblack.txt"]="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/porn/hosts"
            ["unified/stevenblack.txt"]="https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts"

            ["porn/oisd"]="https://nsfw.oisd.nl"
            ["ads-track/oisd"]="https://big.oisd.nl"

            ["hagezi/ultimate"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/ultimate.txt"
            ["hagezi/tif"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/tif.txt"
            ["hagezi/dyndns"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/dyndns.txt"
            ["hagezi/hoster"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/hoster.txt"
            ["hagezi/spam-tlds"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/spam-tlds.txt"
            ["hagezi/dga"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/dga30.txt"
            ["hagezi/gambling"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/gambling.txt"
            ["hagezi/anti-piracy"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/anti.piracy.txt"
            ["hagezi/nosafesearch"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/nosafesearch.txt"
            ["hagezi/doh"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/doh-vpn-proxy-bypass.txt"
            ["hagezi/nsfw"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/nsfw.txt"
          )

          rm -rf hosts
          mkdir -p hosts

          for path in "${!SOURCES[@]}"; do
            url="${SOURCES[$path]}"
            dest="hosts/$path"

            mkdir -p "$(dirname "$dest")"

            echo "Downloading $path"

            curl -A "Mozilla/5.0" \
                 --retry 4 \
                 --retry-delay 5 \
                 --connect-timeout 30 \
                 -fsSL "$url" -o "$dest"
          done

      - name: Generate README
        shell: bash
        run: |
          set -Eeuo pipefail

          BASE="https://raw.githubusercontent.com/${{ github.repository }}/main"

          total=0

          mkdir -p .

          cat > README.md <<EOF
          # Blacklist Hosts

          Curated multi-source domain block registry.

          ## Statistics

          | File | Domains |
          |------|--------|
          EOF

          while read -r file; do

            if [[ "$file" == *.txt ]]; then
              count=$(grep -E '^\|\|[^@].*\^' "$file" | wc -l || true)
            else
              count=$(grep -vE '^(#|!|$)' "$file" \
                      | awk '{print $2}' \
                      | sort -u \
                      | wc -l || true)
            fi

            total=$((total + count))

            echo "| [\`$file\`]($BASE/$file) | $count |" >> README.md

          done < <(find hosts -type f | sort)

          echo "" >> README.md
          echo "**Total Domains:** $total" >> README.md
          echo "" >> README.md
          echo "Last Updated: $(TZ=Asia/Jakarta date '+%Y-%m-%d %H:%M WIB')" >> README.md

      - name: Commit Changes
        run: |
          set -Eeuo pipefail

          git config user.name github-actions
          git config user.email github-actions@github.com

          git add .

          git diff --cached --quiet && exit 0

          git commit -m "auto: update hosts"

          git pull --rebase origin main || true
          git push origin HEAD:main
