name: Update Hosts Registry

on:
  push:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install HostlistCompiler
        run: |
          git clone https://github.com/AdguardTeam/HostlistCompiler.git
          cd HostlistCompiler/src/HostlistCompiler
          dotnet publish -c Release -o ../../../hlc

      - name: Fetch & Process Sources
        shell: bash
        run: |
          set -Eeuo pipefail

          declare -A SOURCES=(

            ["ads-track/adguard"]="https://adguardteam.github.io/HostlistsRegistry/assets/filter_1.txt"
            ["ads-track/oisd-big"]="https://big.oisd.nl"
            ["ads-track/1hosts-xtra"]="https://raw.githubusercontent.com/badmojr/1Hosts/master/Xtra/adblock.txt"

            ["hagezi/ultimate"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/ultimate.txt"

            ["security/urlhaus"]="https://urlhaus.abuse.ch/downloads/hostfile/"
            ["security/phishing-army"]="https://phishing.army/download/phishing_army_blocklist_extended.txt"
          )

          rm -rf sources hosts
          mkdir -p sources hosts

          is_adguard_compatible() {
            file="$1"

            # cek apakah file punya format umum AGH
            if grep -qE '^0\.0\.0\.0|^127\.0\.0\.1|\|\||^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}' "$file"; then
              return 0
            else
              return 1
            fi
          }

          for path in "${!SOURCES[@]}"; do
            url="${SOURCES[$path]}"
            src="sources/$(echo "$path" | tr '/' '_').txt"
            dest="hosts/$path.txt"

            mkdir -p "$(dirname "$dest")"

            echo "Downloading $path"
            curl -L --retry 3 --fail "$url" -o "$src"

            if is_adguard_compatible "$src"; then
              echo "✔ Compatible → RAW copy"
              cp "$src" "$dest"
            else
              echo "⚙ Compiling with HostlistCompiler"
              echo "$PWD/$src" > input.txt

              ./hlc/HostlistCompiler \
                --input input.txt \
                --output "$dest" \
                --format hosts
            fi
          done

      - name: Generate README
        shell: bash
        run: |
          set -Eeuo pipefail

          BASE="https://raw.githubusercontent.com/${{ github.repository }}/main"
          total=0

          count_domains() {
            grep -vE '^\s*($|!|#|@@)' "$1" 2>/dev/null \
            | sed -E '
                s#^\|\|([^/\^\$]+).*#\1#;
                s#^(0\.0\.0\.0|127\.0\.0\.1)[[:space:]]+([^[:space:]]+).*#\2#;
            ' \
            | grep -E '\.' \
            | sort -u \
            | wc -l
          }

          cat > README.md <<EOF
          # Blacklist Hosts (Per Source)

          Processed individually using AdGuard HostlistCompiler if required.

          ## Statistics

          | File | Domains |
          |------|--------|
          EOF

          while read -r file; do
            count=$(count_domains "$file" || echo 0)
            total=$((total + count))
            echo "| [\`$file\`]($BASE/$file) | $count |" >> README.md
          done < <(find hosts -type f | sort)

          echo "" >> README.md
          echo "**Total Domains (Sum of Lists):** $total" >> README.md
          echo "" >> README.md
          echo "Last Updated: $(TZ=Asia/Jakarta date '+%Y-%m-%d %H:%M WIB')" >> README.md

      - name: Commit Changes
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

          git add .

          git diff --cached --quiet && exit 0

          git commit -m "auto: update per-source hosts"
          git push
